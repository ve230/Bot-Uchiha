// index.js
const { default: makeWASocket, useSingleFileAuthState, fetchLatestBaileysVersion } = require("@whiskeysockets/baileys");
const P = require("pino");
const fs = require("fs");
const path = require("path");

// ConfiguraÃ§Ãµes globais
const config = require("./conf.js");

// AutenticaÃ§Ã£o
const { state, saveState } = useSingleFileAuthState("./auth_info.json");

async function startBot() {
    const { version } = await fetchLatestBaileysVersion();
    const sock = makeWASocket({
        version,
        logger: P({ level: "silent" }),
        printQRInTerminal: true,
        auth: state
    });

    sock.ev.on('creds.update', saveState);

    sock.ev.on('connection.update', ({ connection, lastDisconnect, qr }) => {
        if (connection === 'close') startBot();
        else if (connection === 'open') console.log(`âœ… ${config.botName} conectado ao WhatsApp!`);
        if (qr) console.log("ðŸ“Œ Escaneie o QR code para autenticar.");
    });

    // Carregar comandos
    const commands = {};
    fs.readdirSync(path.join(__dirname, "commands"))
        .filter(f => f.endsWith(".js"))
        .forEach(file => {
            const cmd = require(path.join(__dirname, "commands", file));
            commands[cmd.name] = cmd;
        });

    // Menu por categorias
    async function sendMenu(jid) {
        const buttons = [];

        // Itera pelas categorias do conf.js
        for (const [catName, cmds] of Object.entries(config.categories)) {
            // Adiciona um botÃ£o para cada comando
            cmds.forEach((cmd, idx) => {
                if (buttons.length < 10) { // mÃ¡ximo de 10 botÃµes por mensagem
                    buttons.push({
                        index: idx,
                        quickReplyButton: { displayText: cmd, id: `${config.prefix}${cmd}` }
                    });
                }
            });
        }

        // Mensagem de menu
        await sock.sendMessage(jid, {
            text: `ðŸ”¥ ${config.botName} â€” Menu por Categorias ðŸ”¥\nðŸ‘ï¸ Escolha o comando desejado:`,
            footer: `ðŸ‘ï¸ ${config.botName} â€” Poder do Sharingan`,
            templateButtons: buttons
        });
    }

    // Escutar mensagens
    sock.ev.on('messages.upsert', async (m) => {
        const msg = m.messages[0];
        if (!msg.message || msg.key.fromMe) return;
        const jid = msg.key.remoteJid;
        const content = msg.message.conversation || msg.message.extendedTextMessage?.text;
        if (!content) return;

        if (content.startsWith(config.prefix)) {
            const args = content.slice(config.prefix.length).trim().split(/\s+/);
            const cmd = args.shift().toLowerCase();

            // Menu por categorias
            if (cmd === "menu") return sendMenu(jid);

            // Executa comando se existir
            const cmdName = cmd;
            if (commands[cmdName]) {
                try {
                    await sock.sendMessage(jid, { text: config.messages.wait });
                    await commands[cmdName].run({ sock, msg, args });
                    await sock.sendMessage(jid, { text: config.messages.success });
                } catch (e) {
                    console.error(e);
                    await sock.sendMessage(jid, { text: config.messages.error });
                }
            }
        }
    });
}

startBot();